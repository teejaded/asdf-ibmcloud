#!/usr/bin/env bash

set -euo pipefail

[ -z "${ASDF_INSTALL_TYPE+x}" ] && echo "ASDF_INSTALL_TYPE is required" && exit 1
[ -z "${ASDF_INSTALL_VERSION+x}" ] && echo "ASDF_INSTALL_VERSION is required" && exit 1
[ -z "${ASDF_INSTALL_PATH+x}" ] && echo "ASDF_INSTALL_PATH is required" && exit 1

install() {
  local install_type version install_path bin_install_path binary_path \
    download_url tmp_download_dir download_path files

  install_type=$1
  [ "$install_type" != "version" ] && echo "intall type, $install_type, is not supported" && exit 1

  version=$2
  install_path=$3
  bin_install_path="$install_path/bin"
  download_url="$(get_download_url "$version")"
  tmp_download_dir="$(get_tmp_dir)"
  download_path="$tmp_download_dir/ibmcloud_${ASDF_INSTALL_VERSION}.tgz"

  echo "Downloading ibmcloud from ${download_url} to ${download_path}"
  curl -Lo "$download_path" "$download_url"

  echo "Creating bin directory"
  mkdir -p "${bin_install_path}"

  echo "Cleaning previous binaries"
  rm -f "$bin_install_path/*" 2>/dev/null || true

  echo "Copying binaries"
  extract_tar "${download_path}" "$tmp_download_dir"
  files=$(find "${tmp_download_dir}/Bluemix_CLI" -type f | grep -v install)
  for f in $files; do
    cp -p "$f" "${bin_install_path}"
  done

  echo "Creating symlinks"
  [ -f "${bin_install_path}/bluemix" ] && ln -sf "${bin_install_path}/bluemix" "${bin_install_path}/ibmcloud"
  ln -sf "${bin_install_path}/ibmcloud" "${bin_install_path}/bx"
  ln -sf "${bin_install_path}/ibmcloud" "${bin_install_path}/ic"
}

extract_tar() {
  local download_path tmp_download_dir
  download_path="$1"
  tmp_download_dir="$2"

  tar -zxf "${download_path}" --directory "$tmp_download_dir" -s '/IBM_Cloud_CLI/Bluemix_CLI/'

  # If this is a pkg try to extract it
  extract_pkg "$tmp_download_dir/Bluemix_Command_Line_Interface.pkg"
  extract_pkg "$tmp_download_dir/Command_Line_Interface.pkg"
}

extract_pkg() {
  local pkg
  pkg="$1"
  [ ! -f "$pkg/Payload" ] && return 0
  tar -zxf \
    "$pkg/Payload" \
    --directory "$tmp_download_dir" \
    -s ',usr\/local\/Bluemix,Bluemix_CLI,'

  rm -rf "$1" 2>/dev/null || true
}

get_file_name() {
  local version
  version="$1"
  if [ "Linux" = "$(uname)" ]; then
    echo "Bluemix_CLI"
  else
    echo "IBM_Cloud_CLI"
  fi
}

get_tmp_dir() {
  if [ -z "${TMPDIR:-}" ]; then
    mktemp -d -t ibmcloud_XXXXXX
  else
    echo "$TMPDIR"
  fi
}

get_download_url() {
  local version platform arch
  version="$1"
  [ "Linux" = "$(uname)" ] && platform="linux" || platform="osx"
  if [ "$platform" = "osx" ]; then
    arch=""
  elif [ "x86_64" = "$(uname -m)" ]; then
    arch="64"
  else
    arch="32"
  fi

  echo "https://clis.ng.bluemix.net/download/bluemix-cli/${version}/${platform}${arch}"
}

install "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
